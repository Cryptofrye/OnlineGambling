# When to stop

```{r stop load and select data}
# load data
stop <- read_csv("../../data/processed/stop.csv")
```

In this section, we analyze when players decided to stop. For this analysis, players need to have at least 10 rounds in total (all sessions combined) to be included in the analysis. The table below shows the number of players and rounds left in this analysis.

```{r stop - data preparation, results='asis'}
# players need to have at least 10 rounds
# in order to be included in the analysis
players_exclude <- stop %>% 
  filter(
    round_pos == "overall",
    total_count < 10
  ) %>%
  .$id_player %>% unique

stop <- stop %>% filter(!id_player %in% players_exclude)

# calculate the remaining number of players and rounds
count <- stop %>%
  filter(round_pos == "overall") %>%
  group_by(group) %>%
  summarize(
    player = n(),
    round = mean(total_count),
    sd = sd(total_count),
    min = min(total_count),
    max = max(total_count)
  )

kable(count, caption = "Number of players and rounds left")
```

## Plot

For the remaining players, we calculate the overall probability of winning (using all game rounds), and the probability of winning on the last round of each session, when players decided to stop. These winning probabilities are plotted below for the two groups separately.  

(ref:end-session-plot-cap) Probability of winning in all game rounds and at the end of a session. Error bars stand for 95\% within-subject confidence intervals.

```{r stop plot, fig.cap="(ref:end-session-plot-cap)", fig.width=3.5, fig.height=3.5}
# for the high-risk and the low-risk group separately,
# calculate the mean winning probabilities for rounds at the end of session
# and for all round combined
stop_summary <- stop %>%
  group_by(group) %>%
  group_modify(~Rmisc::summarySEwithin(.x, measurevar = "win_prob", idvar = "id_player",
                        withinvars = "round_pos")) %>%
  mutate(round_pos = factor(round_pos, levels = c("overall", "end")))

# plot winning probabilities
stop_plot <- ggplot(stop_summary, aes(round_pos, win_prob, color = group)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(aes(group = group), linetype = "dashed", position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = win_prob-ci, ymax = win_prob+ci), width = 0.2,
                position = position_dodge(width = 0.5)) +
  # use colorblind-friendly color
  scale_color_manual(values=color_values) + 
  scale_x_discrete(labels=c("end" = "End of session", "overall" = "All rounds")) +
  labs(x = "Position of a round", 
       y = "Probability of winning (%)",
       color = "Group") +
  theme(legend.position = "top", legend.direction = "horizontal")

stop_plot

ggsave("figure/stop.pdf", stop_plot, width = 3.5, height = 3.5)
```

## ANOVA

The winning probabilities are analyzed with a mixed ANOVA, with the position of a round (all rounds vs. end of session, within subjects) and the risk level (high vs. low, between subjects) as independent variables.

```{r stop anova analysis, cache = TRUE, results = "asis"}
# run an ANOVA
stop_anova <- aov_ez(id = "id_player"
                     , dv = "win_prob"
                     , within = "round_pos"
                     , between = "group"
                     , data = stop)

stop_anova <- nice(stop_anova)

# do a bit formatting
stop_anova <- stop_anova %>%
  mutate(
    Effect = c("Risk Level", "Round Position", "Interaction"),
    # remove asterisks from the F values
    `F` = str_remove_all(`F`, "[*]"),
    # remove whitespace
    `F` = str_trim(`F`)
  ) %>%
  rename(p = "p.value")

kable(stop_anova, 
      caption = "When do players decide to stop?",
      booktabs = T, align = "l")

# # show the table in latex code
# kable(stop_anova, "latex",
#       caption = "Anova on the decision to stop playing",
#       booktabs = T, align = "l") %>%
#   kable_styling(latex_options = "scale_down")
```

## Pairwise comparisons

Next we conduct a series of pairwise comparisons. First, we examine the effects within groups, by comparing the overall winning probability against the winning probability at session end for each group, separately. Next we examine the effects between groups, by comparing the overall winning probabilities between the two groups, and the winning probabilities at session end between the two groups. We further calculate a difference score for each player (overall winning probability - winning probability at session end) and compare the difference scores between two groups. P values are corrected for multiple comparisons using the Holm-Bonferroni method.

```{r stop pairwise t tests, results='asis'}
# calculate mean winning probabilities for rounds at session end
# and all rounds combined
win_prob <- stop %>%
  group_by(round_pos) %>%
  summarize(mean = mean(win_prob), sd = sd(win_prob))

# calculate mean winning probabilities for rounds at session end
# and all rounds combined, for two groups separately
win_prob_per_group <- stop %>%
  group_by(group, round_pos) %>%
  summarize(mean = mean(win_prob), sd = sd(win_prob))

# for pairwise comparisons, we need the data in the wide format
stop_wide <- stop %>%
  pivot_wider(id_cols = c(group, id_player),
              names_from = round_pos,
              values_from = win_prob) %>%
  # calculate a difference score
  mutate(diff = end - overall)


# within-group comparisons
# first, compare the effect within each group
comp_within <- stop_wide %>%
  group_by(group) %>%
  group_modify(~TES(.x$end, .x$overall, paired = TRUE)) %>%
  mutate(d = dz, g = gav) %>%
  ungroup() %>% select(-group, -dz, -gav, -dav)

# between group comparisons
# next, compare the probabilities and the difference scores between groups
comp_between1 <- TES(filter(stop_wide, group == "High-Risk")$end,
                     filter(stop_wide, group == "Low-Risk")$end, paired = FALSE)

comp_between2 <- TES(filter(stop_wide, group == "High-Risk")$overall,
                     filter(stop_wide, group == "Low-Risk")$overall, paired = FALSE)

comp_between3 <- TES(filter(stop_wide, group == "High-Risk")$diff,
                     filter(stop_wide, group == "Low-Risk")$diff, paired = FALSE)

comp_between <- bind_rows(comp_between1, comp_between2, comp_between3)

# combine and correct p values for multiple comparisons
comp <- bind_rows(comp_within, comp_between) %>%
  mutate(
    Comparison = c("Session End vs. Overall (High-Risk)", 
                   "Session End vs. Overall (Low-Risk)", 
                   "High- vs. Low-Risk (Session End)",
                   "High- vs. Low-Risk (Overall)",
                   "High- vs. Low-Risk (Difference)"),
    pt = p.adjust(pt, method = "holm")
  ) 

# do some formatting
comp <- comp %>%
  mutate(
    across(diff:upperCI, ~round(.x, digits = 1)),
    across(c(d, g), ~round(.x, digits = 3)),
    t = round(t, digits = 1),
    df = round(df, digits = 1),
    p = ifelse(pt < .001, "<.001", sprintf("%.3f", round(pt, digits = 3))),
    logBF = round(logBF, digits = 2)
  ) %>%
  select(Comparison, diff:t, p, logBF, g) 

# show the table
kable(comp, caption = "Pairwise comparisons for effects on when to stop",
      booktabs = T, align = "l") %>%
  scroll_box(width = "100%", height = "100%")

# # show the table in latex code
# kable(comp, "latex",
#       caption = "Pairwise comparisons for effects on when to stop",
#       booktabs = T, align = "l") %>%
#   kable_styling(latex_options = "scale_down")
```

```{r stop non-parametric tests, results='asis'}
source("function/RANKT.R")

# within-group comparisons
# first, compare the effect within each group
comp_within <- stop_wide %>%
  group_by(group) %>%
  group_modify(~RANKT(.x$end, .x$overall, paired = TRUE)) %>%
  ungroup() %>% select(-V, -group)

# between group comparisons
# next, compare the probabilities and the difference scores between groups
comp_between1 <- RANKT(filter(stop_wide, group == "High-Risk")$end,
                     filter(stop_wide, group == "Low-Risk")$end, paired = FALSE)

comp_between2 <- RANKT(filter(stop_wide, group == "High-Risk")$overall,
                     filter(stop_wide, group == "Low-Risk")$overall, paired = FALSE)

comp_between3 <- RANKT(filter(stop_wide, group == "High-Risk")$diff,
                     filter(stop_wide, group == "Low-Risk")$diff, paired = FALSE)

comp_between <- bind_rows(comp_between1, comp_between2, comp_between3) %>%
  select(-W)

# combine and correct p values for multiple comparisons
comp <- bind_rows(comp_within, comp_between) %>%
  mutate(
    Comparison = c("Session End vs. Overall (High-Risk)", 
                   "Session End vs. Overall (Low-Risk)", 
                   "High- vs. Low-Risk (Session End)",
                   "High- vs. Low-Risk (Overall)",
                   "High- vs. Low-Risk (Difference)"),
    p = p.adjust(p, method = "holm")
  ) 

# do some formatting
comp <- comp %>%
  mutate(
    p = ifelse(p < .001, "<.001", sprintf("%.3f", round(p, digits = 3))),
  ) %>%
  select(Comparison, rank_biserial, lowerCI, upperCI, p) 

# show the table
kable(comp, caption = "Pairwise comparisons for effects on when to stop (non-parametric)",
      booktabs = T, align = "l") %>%
  scroll_box(width = "100%", height = "100%")
```

